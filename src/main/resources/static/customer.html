<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Solace Messages</title>
    <link rel="icon" href="http://localhost:8081/favicon.ico" type="image/x-icon">
    <script src="solclient.js"></script>
    <!-- Load the Persistence with Queues - Queue Consumer  -->
    <script src="QueueConsumer.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h2 { color: #333; }
        .message { background-color: #f0f0f0; padding: 10px; margin: 5px 0; border-radius: 5px; }
        .error { color: red; }
    </style>
</head>
<script>

    const urlParams = new URLSearchParams(window.location.search);

    const reservationID = urlParams.get('reservationID');

    // Log the parameters to the console
    console.log("reservationID:", reservationID);

    function fetchReservationDetails(reservationID) {

        console.log(reservationID)
        // const button = document.getElementById("viewLink");
        // const uniqueID = button.dataset.uniqueId; // Retrieve stored uniqueID
            
        fetch(`/customer/getReservationInfo/${reservationID}`)
                .then(response => response.json()) // Assuming the server returns JSON
                .then(data => {
                    if (data) {
                        console.log(data)

                        subscriber = new QueueConsumer('customerQueue/' + data.uniqueID);

                        if (subscriber) {
                            subscriber.connectToSolace();

                            document.getElementById("connect").addEventListener("click", subscriber.connect);
                            document.getElementById("disconnect").addEventListener("click", subscriber.disconnect);
                            document.getElementById("startconsume").addEventListener("click", subscriber.startConsume);
                            document.getElementById("stopconsume").addEventListener("click", subscriber.stopConsume);
                            document.getElementById("clear").addEventListener("click", subscriber.clear);
                        }

                    } else {
                        alert("Error: Invalid response from server.");
                    }
                })
                .catch(error => {
                    console.error("Error fetching reservation details:", error);
                    alert("Failed to fetch reservation details.");
                });
        }

    var subscriber = null;
    window.onload = function () {
      // Initialize factory with the most recent API defaults
      var factoryProps = new solace.SolclientFactoryProperties();
      factoryProps.profile = solace.SolclientFactoryProfiles.version10_5;
      solace.SolclientFactory.init(factoryProps);

      // enable logging to JavaScript console at WARN level
      // NOTICE: works only with "solclientjs-debug.js"
      solace.SolclientFactory.setLogLevel(solace.LogLevel.WARN);

      fetchReservationDetails(reservationID);

      // create the consumer, specifying name of the queue
      
      // assign buttons to the subscriber functions

    };
    function iframeloaded(){
      if (subscriber) {
          subscriber.connectToSolace();
      }
    };
  </script>
<body>
    <h2>Live Messages f</h2>

    <!-- Message Section -->
    <h3>Updates</h3>
    <div id="messages"></div>

    <!-- Error message -->
    <div id="errorMessage" class="error" style="display: none;">
        <p>Could not recieve updates</p>
    </div>

    <input id="hosturl" type="text" value="ws://localhost:8008">
    <input id="message-vpn" type="text" placeholder="Message VPN" value="default">
    <input id="username" type="text" placeholder="Username">
    <input id="password" type="password" placeholder="Password">
    <p>
        <button type="button" class="pure-button pure-button-primary" id="connect">Connect</button>
        <button type="button" class="pure-button button-error" id="disconnect">Disconnect</button>
      </p>
      <p>
        <button type="button" class="pure-button pure-button-primary" id="startconsume">Consume messages </button>
        <button type="button" class="pure-button button-error" id="stopconsume">Stop consuming</button>
        <button type="button" class="pure-button pure-button-secondary right" id="clear">Clear</button>
      </p>

      <textarea id="log" rows="20" cols="90" autofocus></textarea>

    <script>
    </script>
</body>
</html>
